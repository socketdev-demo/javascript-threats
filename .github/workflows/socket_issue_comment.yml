name: socket-security-issue-comment
run-name: Socket Security Github Action
on:
  issue_comment:
    types: [created, edited]
jobs:
  socket-security-comment:
    permissions:
      issues: write
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request}}
    steps:
      - name: Check PR Issue Comment
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT_STR=$(echo "$COMMENT_BODY" | head -n 1)
          START_PAYLOAD='{
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "*${{ github.event.comment.user.login }}* commented '
          END_PAYLOAD=' on ${{ github.event.issue.pull_request.url }}"
                        }
                    }
                ]
            }'
          SLACK_PAYLOAD=$START_PAYLOAD'`'$COMMENT_STR'`'$END_PAYLOAD
          echo "${{ github.event.comment.body }}" | head -n 1 | grep -iq "SocketSecurity ignore"
          if [ $? -eq 0 ]; then
            curl -X POST -H 'Content-type: application/json' --data $SLACK_PAYLOAD $SLACK_WEBHOOK
          fi
          
